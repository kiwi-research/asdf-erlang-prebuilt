#!/usr/bin/env bash
# List available Erlang/OTP versions from prebuilt sources.
# macOS: queries erlef/otp_builds CSV
# Linux: queries hex.pm builds.txt

set -euo pipefail

detect_arch() {
  case "$(uname -m)" in
    x86_64) echo "x86_64" ;;
    aarch64 | arm64) echo "aarch64" ;;
    *)
      echo "Unsupported architecture: $(uname -m)" >&2
      exit 1
      ;;
  esac
}

list_macos_versions() {
  local arch
  case "$(uname -m)" in
    x86_64) arch="x86_64" ;;
    arm64) arch="aarch64" ;;
  esac

  local url="https://raw.githubusercontent.com/erlef/otp_builds/refs/heads/main/builds/${arch}-apple-darwin.csv"

  if ! curl -fs "$url"; then
    echo "Failed to fetch erlef/otp_builds versions from: $url" >&2
    return 1
  fi
}

detect_linux_arch() {
  if command -v dpkg &>/dev/null; then
    dpkg --print-architecture
  else
    case "$(uname -m)" in
      x86_64) echo "amd64" ;;
      aarch64) echo "arm64" ;;
    esac
  fi
}

# Map the current distro to a compatible Ubuntu version for hex.pm builds.
# hex.pm provides builds for Ubuntu 20.04, 22.04, and 24.04.
detect_ubuntu_release() {
  # Allow explicit override
  if [ -n "${ASDF_ERLANG_UBUNTU_RELEASE:-}" ]; then
    echo "$ASDF_ERLANG_UBUNTU_RELEASE"
    return
  fi

  local distro_id=""
  local version_id=""
  if [ -f /etc/os-release ]; then
    distro_id=$(. /etc/os-release && echo "${ID:-}")
    version_id=$(. /etc/os-release && echo "${VERSION_ID:-}")
  fi

  case "$distro_id" in
    ubuntu)
      echo "$version_id"
      ;;
    debian)
      # Map Debian versions to compatible Ubuntu builds
      case "${version_id%%.*}" in
        10) echo "18.04" ;;
        11) echo "20.04" ;;
        12) echo "22.04" ;;
        *) echo "24.04" ;;
      esac
      ;;
    *)
      # Default to latest Ubuntu LTS
      echo "24.04"
      ;;
  esac
}

list_linux_versions() {
  local arch
  arch=$(detect_linux_arch)

  local ubuntu_release
  ubuntu_release=$(detect_ubuntu_release)

  local url="https://builds.hex.pm/builds/otp/${arch}/ubuntu-${ubuntu_release}/builds.txt"

  if ! curl -fs "$url"; then
    echo "Failed to fetch hex.pm versions from: $url" >&2
    return 1
  fi
}

sort_versions() {
  LC_ALL=C sort -t. -k 1,1 -k 2,2n -k 3,3n
}

get_versions() {
  local raw
  case "$(uname -s)" in
    Darwin)
      raw=$(list_macos_versions) || exit 1
      # CSV format: OTP-version,... — skip header, extract first field
      echo "$raw" | sed 1d | cut -d "," -f 1
      ;;
    Linux)
      raw=$(list_linux_versions) || exit 1
      # builds.txt format: "OTP-version hash" — extract first field
      echo "$raw" | cut -d " " -f 1
      ;;
    *)
      echo "Unsupported OS: $(uname -s)" >&2
      exit 1
      ;;
  esac
}

# Normalize versions:
#   OTP-X.Y.Z -> X.Y.Z (strip prefix)
#   X.Y -> X.Y.0 (ensure semver-compatible 3-component format for proto)
# Filter out pre-release versions (rc, etc.)
versions=$(
  get_versions |
    sed -E 's/^OTP-//' |
    grep -E '^[0-9]+\.[0-9]+(\.[0-9]+)?$' |
    sed -E 's/^([0-9]+\.[0-9]+)$/\1.0/' |
    sort_versions
)

# Output as single space-separated line (asdf convention)
echo $versions
